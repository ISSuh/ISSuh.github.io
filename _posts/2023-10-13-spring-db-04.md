---
title: Spring Framework DB - 스프링을 통한 트랜잭션 동작 개선
date: 2023-10-13 16:20:00 +0900
categories: [Web, Spring Framework]
published: true
tags:
- Web
- Spring Framework
- DataBase
---

### 어플리케이션 구조
현재 가장 많이 사용하는 어플리케이션의 구조는 역할에 따라 3가지 계층으로 나누는 것 

![Alt text](/assets/posts/img/spring/spring_db_1/spring_db_04_01.png)
  - **프리젠테이션 계증**
    - UI와 관련된 처리 담당
    - 웹 요청과 응답
    - 사용자 요청을 검증
    - 주 사용 기술 : 서블릿, HTTP와 같은 웹 기술, 스프링 MVC
  - **서비스 계증**
    - 비지니스 로직 담당
    - 가급적이면 특정 기술에 의존하지 않고 순수 자바코드로 작성하는 것이 좋음
  - **데이터 접근 계증**
    - 실제 데이터베이스에 접근하는 코드
    - 주요 사용 기술 : JDBC, JPA, File, Redis, Mongo DB 등

#### 순수한 서비스 계층
보통 핵심 비지니스 로직을 수행하는 서비스 계층이 다른 계층보다 우선시 되곤 함. 시간이 흘러 UI, 웹과 같은 기술이 변하고 데이터 저장 기술 또한 다른 기술로 변한다고 하더라도 비지니스 로직은 최대한 변경 없이 유지되어야 하기 떄문

서비스 계층을 최대한 변경없이 유지하려면 특정 기술에 종속적이지 않게 개발해야 함. 그래야 비지니스 로직을 유지보수 하거나 테스트 및 비지니스 로직 변경등에 있어서 수정을 최소화 할 수 있음

### 트랜잭션 추상화
구현 기술에 따른 트랜젝션 사용번
  - 트랜잭션은 원자적 단위의 비지니스 로직을 처리하기 위해 사용됨
  - 구현 기술마다 트랜잭션을 사용하는 방법이 다름
    - JDBC : connection.setAudoCommit(false)
    - JPA : transaction.begin()

트랜잭션을 사용하는 코드는 데이터 접근 기술마다 다름. 만약 JDBC 기술을 사용해 JDBC 트랜잭션에 의존하다가 JPA 기술로 변경하게 되면 서비스 계층의 트랜잭션을 처리하는 코드를 모두 수정해야함

![Alt text](/assets/posts/img/spring/spring_db_1/spring_db_04_02.png)
  - JDBC 트랜잭션에 의존

![Alt text](/assets/posts/img/spring/spring_db_1/spring_db_04_03.png)
  - JDBC 기술을 사용하다가 JPA 기술로 변경할 시 서비스 계층의 코드를 JPA 기술을 사용하도록 수정해야 함

위와 같은 문제를 해결하기 위한 방법중 하나는 아래와 같이 트랜잭션 기능을 추상화 하는 것

```java
public interface TxManager {
  public void begin();
  public void commit();
  public void rollback();
}
```

![Alt text](/assets/posts/img/spring/spring_db_1/spring_db_04_04.png)

서비스는 특정 트랜잭션 기술에 직접 의존하는 것이 아닌 TxManager 라는 추상화된 인터페이스에 의존하게 함
이후 원하는 구현체를 DI를 통해 주입받아 사용하면 됨.
이렇게 되면 클라이언트인 서비스는 인터페이스에 의존하고 DI를 사용한 덕분에 OCP 원칙을 지킬 수 있음

### 스프링의 트랜잭션 추상화 및 동기화
스프링이 제공하는 트랜잭션 매니저는 크게 2가지 역할을 함
  - 트랜잭션 추상화
  - 트랜잭셩 동기화

#### 스프링의 트랜잭션 추상화
스프링은 이미 위와 같은 트랜잭션 추상화 기능을 제공하고 있음. 또한 각 데이터 접근 기술에 대한 트랜잭션 구현체도 대부분 구현되어 있어 개발자는 단순히 사용만 하면 됨

![Alt text](/assets/posts/img/spring/spring_db_1/spring_db_04_05.png)
  - 스프링의 트랜잭션 추상화의 핵심은 PlatformTransactionManager 인터페이스
    - org.springframework.transaction.PlatformTransactionManager

#### 스프링의 트랜잭션 동기화
트랜잭션을 유지하려면 트랜잭션의 시작부터 끝까지 같은 데이터베이스 커넥션을 유지하여 세션을 유지해야 함.
결국 같은 커넥션을 동기화하기 위해서 이전에는 파라미터로 커넥션을 전달하는 방법을 사용했지만 해당 방법은 코드의 가독성과 중복 코드등의 여러 단점이 존재 함

![Alt text](/assets/posts/img/spring/spring_db_1/spring_db_04_06.png)
  - 스프링은 트랜잭션 동기화 매니저를 제공함
    - 트랜잭션 동기화 매니저는 쓰레드 로컬(ThreadLocal)을 사용하여 커넥션을 동기화 해줌
    - 트랜잭션 매니저는 내부에서 해당 트랜잭션 동기화 매니저를 사용함
  - 트랜잭션 동기화 매니저는 쓰레드 로컬을 사용하기 떄문에 멀티쓰레드 상황에 안전하게 커넥션을 동기화 할 수 있게 해줌. 그러므로 커넥션이 필요하면 트랜잭션 동기화 매니저를 통해 커넥션을 획득하면 됨

다음 트랜잭션 동기화 매니저 클래스를 열어서 확인해보면 쓰레드 로컬을 사용하는 것을 알 수 있음
  - org.springframework.transaction.support.TransactionSynchronizationManager

> 쓰레드 로컬을 사용하면 각각의 쓰레드마다 별도의 저장소가 부여되어 쓰레드는 자기 자신의 저장소의 데이터에만 접근할 수 있음

##### 트랜잭션 동기화 매니저의 동작방식
  - 트랜잭션의 시작하려면 커넥션이 필요하므로 트랜잭션 매니저는 DataSource를 통해 커넥션을 만들고 트랜잭션을 시작함
  - 트랜잭션 매니저는 트랜잭션이 시작된 커넥션을 트랜잭션 동기화 매니저에 보관
  - Repository는 트랜잭션 동기화 매니저에 보관된 커넥션을 꺼내서 사용 함
  - 트랜잭션이 종료되면 트랜잭션 매니저는 트랜잭션 동기화 매니저에 보관된 커넥션을 통해 트랜잭션을 종료하고 커넥션을 닫음


### 트랜잭션 - 트랜잭션 문제 해결 - 트랜잭션 매니저1
### 트랜잭션 - 트랜잭션 문제 해결 - 트랜잭션 매니저2
### 트랜잭션 - 트랜잭션 문제 해결 - 트랜잭션 템플릿
### 트랜잭션 - 트랜잭션 문제 해결 - 트랜잭션 AOP 이해
### 트랜잭션 - 트랜잭션 문제 해결 - 트랜잭션 AOP 적용
### 트랜잭션 - 트랜잭션 문제 해결 - 트랜잭션 AOP 정리
### 트랜잭션 - 스프링 부트의 자동 리소스 등록
### 트랜잭션 - 정리

### 참고
 - 스프링 DB - 데이터 접근 핵심 원리(김영한)

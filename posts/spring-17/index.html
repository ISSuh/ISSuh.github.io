<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Spring Framework - AOP 주의사항" /><meta property="og:locale" content="en" /><meta name="description" content="프록시와 내부 호출 문제" /><meta property="og:description" content="프록시와 내부 호출 문제" /><link rel="canonical" href="https://issuh.github.io/posts/spring-17/" /><meta property="og:url" content="https://issuh.github.io/posts/spring-17/" /><meta property="og:site_name" content="My Technical Diary" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-11-08T12:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Spring Framework - AOP 주의사항" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-04-23T22:54:02+09:00","datePublished":"2023-11-08T12:00:00+09:00","description":"프록시와 내부 호출 문제","headline":"Spring Framework - AOP 주의사항","mainEntityOfPage":{"@type":"WebPage","@id":"https://issuh.github.io/posts/spring-17/"},"url":"https://issuh.github.io/posts/spring-17/"}</script><title>Spring Framework - AOP 주의사항 | My Technical Diary</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="My Technical Diary"><meta name="application-name" content="My Technical Diary"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/profile.jpeg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">My Technical Diary</a></div><div class="site-subtitle font-italic">ISSuh's tech blog</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/aboutme/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT ME</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/ISSuh" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['yoyus5','naver.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Spring Framework - AOP 주의사항</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Spring Framework - AOP 주의사항</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/ISSuh">ISSuh</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1699412400" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2023-11-08 </em> </span> <span> Updated <em class="timeago" data-ts="1713880442" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2024-04-23 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4108 words"> <em>22 min</em> read</span></div></div></div><div class="post-content"><h3 id="프록시와-내부-호출-문제"><span class="mr-2">프록시와 내부 호출 문제</span><a href="#프록시와-내부-호출-문제" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>스프링은 프록시 방식의 AOP를 사용한다. 따라서 AOP를 적용하려면 항상 프록시를 통해서 대상 객체(Target)을 호출해야 한다. 이렇게 해야 프록시에서 먼저 어드바이스를 호출하고 이후 대상 객체를 호출한다. 만약 프록시를 거치지 않고 대상 객체를 직접 호출하게되면 AOP가 적용되지 않고 어드바이스도 호출되지 않는다.</p><p>스프링은 의존관계 주입시, AOP가 적용된 객체라면 대상 객체 대신에 프록시를 스프링 빈으로 등록하기 떄문에 외부에서 대상 객체를 직접 호출하는 문제는 발생하지 않는다. 그러나 대상 객체의 내부에서 내부 메소드 호출이 발생하면 프록시를 거치치 않고 대상 객체를 직접 호출하는 문제가 발생한다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="nd">@Slf4j</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CallServiceV0</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">external</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"call external"</span><span class="o">);</span>

    <span class="c1">// this.internal()로 호출됨</span>
    <span class="n">internal</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">internal</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"call internal"</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="nd">@Slf4j</span>
<span class="nd">@Aspect</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CallLogAspect</span> <span class="o">{</span>

  <span class="nd">@Before</span><span class="o">(</span><span class="s">"execution(* hello.aop.internalcall..*.*(..))"</span><span class="o">)</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doLog</span><span class="o">(</span><span class="nc">JoinPoint</span> <span class="n">joinPoint</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"aop={}"</span><span class="o">,</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">getSignature</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="nd">@Import</span><span class="o">(</span><span class="nc">CallLogAspect</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@SpringBootTest</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CallServiceV0Test</span> <span class="o">{</span>

  <span class="nd">@Autowired</span>
  <span class="nc">CallServiceV0</span> <span class="n">callService</span><span class="o">;</span>

  <span class="nd">@Test</span>
  <span class="kt">void</span> <span class="nf">external</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">callService</span><span class="o">.</span><span class="na">external</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><pre><code class="language-log"># external() Test
2023-11-08 14:17:10.280  INFO 60643 --- [           main] h.aop.internalcall.aop.CallLogAspect     : aop=void hello.aop.internalcall.CallServiceV0.external()
2023-11-08 14:17:10.289  INFO 60643 --- [           main] hello.aop.internalcall.CallServiceV0     : call external
2023-11-08 14:17:10.289  INFO 60643 --- [           main] hello.aop.internalcall.CallServiceV0     : call internal

# internal() Test
2023-11-08 14:17:10.297  INFO 60643 --- [           main] h.aop.internalcall.aop.CallLogAspect     : aop=void hello.aop.internalcall.CallServiceV0.internal()
2023-11-08 14:17:10.297  INFO 60643 --- [           main] hello.aop.internalcall.CallServiceV0     : call internal
</code></pre><p><br /></p><p>실행 결과를 확인해보면 callService.external() 실행시 프록시가 호출되어 CallLogAspect의 어드바이스가 호출되었고, AOP Proxy는 실제 대상 객체인 target.external() 을 호출하여 로그가 출력되었다. 그러나 이후 external() 메소드 내부에서 internal() 호출시 CallLogAspect의 어드바이스가 호출되지 않았다.</p><p>이는 자바에서는 메소드 앞에 별도의 참조가 없나면 this라는 뜻으로 자기자신의 인스턴스를 가리키기 떄문이다. 즉, 자기 자신의 내부 메소드를 호출하는 this.internal()이 되어 프록시를 거치지 않고 실제 대상 객체의 인스턴스의 internal() 메소드를 바로 호출하기 때문이다.</p><p><img data-src="/assets/posts/img/spring/spring_basic/spring_17_01.png" alt="Alt text" data-proofer-ignore></p><p>스프링은 프록시 방식의 AOP를 사용하고, 프록시 방식의 AOP는 메소드 내부 호출에는 프록시를 적용할 수 없으므로 위와 같은 문제가 발생하게 된다.</p><h4 id="대안-1---자기-자신-주입"><span class="mr-2">대안 1 - 자기 자신 주입</span><a href="#대안-1---자기-자신-주입" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>내부 호출을 해결하는 가장 간단한 방법은 자기 자신을 의존관계 주입 받는 것이다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="cm">/**
 * 참고: 생성자 주입은 순환 사이클을 만들기 때문에 실패한다.
 */</span>
<span class="nd">@Slf4j</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CallServiceV1</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="nc">CallServiceV1</span> <span class="n">callService</span><span class="o">;</span>

  <span class="nd">@Autowired</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCallServiceV1</span><span class="o">(</span><span class="nc">CallServiceV1</span> <span class="n">callService</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">callService</span> <span class="o">=</span> <span class="n">callService</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">external</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"call external"</span><span class="o">);</span>

    <span class="c1">// 자기 자신을 주입 받고 해당 객체로 메소드 호출</span>
    <span class="n">callService</span><span class="o">.</span><span class="na">internal</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">internal</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"call internal"</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="nd">@Import</span><span class="o">(</span><span class="nc">CallLogAspect</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@SpringBootTest</span><span class="o">(</span><span class="n">properties</span> <span class="o">=</span> <span class="s">"spring.main.allow-circular-references=true"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CallServiceV1Test</span> <span class="o">{</span>

  <span class="nd">@Autowired</span>
  <span class="nc">CallServiceV1</span> <span class="n">callService</span><span class="o">;</span>

  <span class="nd">@Test</span>
  <span class="kt">void</span> <span class="nf">external</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">callService</span><span class="o">.</span><span class="na">external</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><pre><code class="language-log">2023-11-08 14:41:18.835  INFO 61926 --- [           main] h.aop.internalcall.aop.CallLogAspect     : aop=void hello.aop.internalcall.CallServiceV1.external()
2023-11-08 14:41:18.843  INFO 61926 --- [           main] hello.aop.internalcall.CallServiceV1     : call external
2023-11-08 14:41:18.843  INFO 61926 --- [           main] h.aop.internalcall.aop.CallLogAspect     : aop=void hello.aop.internalcall.CallServiceV1.internal()
2023-11-08 14:41:18.843  INFO 61926 --- [           main] hello.aop.internalcall.CallServiceV1     : call internal
</code></pre><p><img data-src="/assets/posts/img/spring/spring_basic/spring_17_02.png" alt="Alt text" data-proofer-ignore></p><p>간편한 방법이지만, 위 방법은 스프링 부트 2.6부터는 순환 참조를 기본적으로 금지하도록 정책이 변경되었기 떄문에 2.6 이상의 스프링 부트에서는 아래와 같이 스프링 옵션을 주어야 동작 가능하다.</p><ul><li>spring.main.allow-circular-references=true</ul><h5 id="지연-조회"><span class="mr-2">지연 조회</span><a href="#지연-조회" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5></h5><p>위 예시에서 생성자 주입이 실패하는 이유는 자기 자신을 생성하면서 주입해야 하기 떄문이다. 이 경우 setter 주입을 사용하거나 지연조회를 사용하면 된다.</p><p>setter 주입의 경우 위 예시와 같은 방법이며 지연조회의 경우는 ObjectProvider(Provider), ApplicationContext를 사용하면 된다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="cm">/**
 * ObjectProvider(Provider), ApplicationContext를 사용해서 지연(LAZY) 조회
 */</span>
<span class="nd">@Slf4j</span>
<span class="nd">@Component</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CallServiceV2</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ObjectProvider</span><span class="o">&lt;</span><span class="nc">CallServiceV2</span><span class="o">&gt;</span> <span class="n">callServiceProvider</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">external</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"call external"</span><span class="o">);</span>

    <span class="nc">CallServiceV2</span> <span class="n">callService</span> <span class="o">=</span> <span class="n">callServiceProvider</span><span class="o">.</span><span class="na">getObject</span><span class="o">();</span>
    <span class="n">callService</span><span class="o">.</span><span class="na">internal</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">internal</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"call internal"</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>ObjectProvider는 객체를 스프링 컨테이너에서 조회하는 것을 스프링 빈 생성 시점이 아닌 실제 객체를 사용하는 지점으로 지연시킬 수 있다.</p><h4 id="대안-3---구조-변경"><span class="mr-2">대안 3 - 구조 변경</span><a href="#대안-3---구조-변경" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>앞의 방법은 자기 자신을 주입하는 방법으로 순환참조하는 형식이어서 권장되는 방법은 아니다. 가장 나은 대한은 내부 호출이 발생하지 않도록 아예 클래스를 나눠 구조를 분리하는 것이다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="cm">/**
 * 구조를 변경(분리)
 */</span>
<span class="nd">@Slf4j</span>
<span class="nd">@Component</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CallServiceV3</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">InternalService</span> <span class="n">internalService</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">external</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"call external"</span><span class="o">);</span>
    <span class="n">internalService</span><span class="o">.</span><span class="na">internal</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="nd">@Slf4j</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">InternalService</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">internal</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"call internal"</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><pre><code class="language-log">2023-11-08 15:52:20.143  INFO 63553 --- [           main] h.aop.internalcall.aop.CallLogAspect     : aop=void hello.aop.internalcall.CallServiceV3.external()
2023-11-08 15:52:20.149  INFO 63553 --- [           main] hello.aop.internalcall.CallServiceV3     : call external
2023-11-08 15:52:20.149  INFO 63553 --- [           main] h.aop.internalcall.aop.CallLogAspect     : aop=void hello.aop.internalcall.InternalService.internal()
2023-11-08 15:52:20.152  INFO 63553 --- [           main] hello.aop.internalcall.InternalService   : call internal
</code></pre><p><img data-src="/assets/posts/img/spring/spring_basic/spring_17_03.png" alt="Alt text" data-proofer-ignore></p><p>내부 호출 자체가 사라지고 callService -&gt; internalService를 호출하는 구조로 변경되었다. internalService가 별도의 클래스로 빠져나오면서 자연스럽게 AOP가 적용된다.</p><p>여기서 구조를 변경한다는 것은 단순히 분리하는 것 뿐만 아니라 다양한 방법이 있을수 있다. 예를 들면 다음과 같이 클라이언트에서 둘다 호출하는 방법도 있다. 클라이언트 -&gt; external() 클라이언트 -&gt; internal()</p><blockquote><p>참고 AOP는 주로 트랜잭션 적용이나 주요 컴포넌트의 로그 출력 기능에 사용된다. 즉, 인터페이스에 메소드가 나올 정도의 규모에 AOP를 적용하는 것이 적당하다. 풀어서 이야기 한다면 AOP는 public 메소드에만 적용하고 private 메소드 처럼 작은 단위에는 AOP를 적용하지 않는다. AOP를 적용하기 위해 private 메소드를 외부 클래스로 변경하고 public 으로 변경하는 일은 거의 없다.</p></blockquote><h3 id="프록시-기술과-한계"><span class="mr-2">프록시 기술과 한계</span><a href="#프록시-기술과-한계" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><h4 id="타입-캐스팅"><span class="mr-2">타입 캐스팅</span><a href="#타입-캐스팅" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>JDK 동적 프록시와 CGLIB을 사용해서 AOP 프록시를 만드는 방법에는 각각 장단점이 있다. JDK 동적 프록시는 인터페이스가 필수이고 인터페이스를 기반으로 프록시를 생성한다. CGLIB은 구체 클래스를 기반으로 프록시를 생성한다.</p><p>즉, 인터페이스가 없고 구체 클래스만 있는 경우에는 CGLIB을 사용해야 하고 인터페이스가 있는 경우에는 JDK 동적 프록시나 CGLIB 둘중에 하나를 선택할 수 있다.</p><h5 id="jdk-동적-프록시의-한계"><span class="mr-2">JDK 동적 프록시의 한계</span><a href="#jdk-동적-프록시의-한계" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5></h5><p>인터페이스 기반으로 프록시를 생성하는 JDK 동적 프록시는 구체 클래스로 타입 캐스팅이 불가능한 한계가 있다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">jdkProxy</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">MemberServiceImpl</span> <span class="n">target</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MemberServiceImpl</span><span class="o">();</span>
  <span class="nc">ProxyFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ProxyFactory</span><span class="o">(</span><span class="n">target</span><span class="o">);</span>

  <span class="c1">// JDK 동적 프록시 사용 설정</span>
  <span class="n">factory</span><span class="o">.</span><span class="na">setProxyTargetClass</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

  <span class="c1">// 프록시를 인터페이스로 캐스팅 성송</span>
  <span class="nc">MemberService</span> <span class="n">memberServiceProxy</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MemberService</span><span class="o">)</span><span class="n">factory</span><span class="o">.</span><span class="na">getProxy</span><span class="o">();</span>

  <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"proxy class={}"</span><span class="o">,</span> <span class="n">memberServiceProxy</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>

  <span class="c1">// JDK 동적 프록시를 구현 클래스로 캐스팅 시도시 실패</span>
  <span class="c1">// ClassCastException 예외 발생</span>
  <span class="nc">Assertions</span><span class="o">.</span><span class="na">assertThrows</span><span class="o">(</span><span class="nc">ClassCastException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
    <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="nc">MemberServiceImpl</span> <span class="n">memberServiceImplProxy</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MemberServiceImpl</span><span class="o">)</span><span class="n">factory</span><span class="o">.</span><span class="na">getProxy</span><span class="o">();</span>
    <span class="o">});</span>
<span class="o">}</span>
</pre></table></code></div></div><p><img data-src="/assets/posts/img/spring/spring_basic/spring_17_04.png" alt="Alt text" data-proofer-ignore></p><p><strong>JDK 동적 프록시 캐스팅</strong> <img data-src="/assets/posts/img/spring/spring_basic/spring_17_05.png" alt="Alt text" data-proofer-ignore></p><p>JDK Proxy를 대상 클래스인 MemberServiceImpl 타입으로 캐스팅하려 하니 ClassCastException 예외가 발생한다. 예외가 발생하는 이유는 JDK 동적 프록시는 인터페이스를 기반으로 프록시를 생성하기 떄문에 JDK Proxy는 MemberServiceImpl의 존재를 알 수 없기 떄문이다.</p><p>이에 반해 CGLIB을 사용하는 경우는 아래와 같다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">cglibProxy</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">MemberServiceImpl</span> <span class="n">target</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MemberServiceImpl</span><span class="o">();</span>
  <span class="nc">ProxyFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ProxyFactory</span><span class="o">(</span><span class="n">target</span><span class="o">);</span>

  <span class="c1">// CGLIB 프록시 사용</span>
  <span class="n">factory</span><span class="o">.</span><span class="na">setProxyTargetClass</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

  <span class="c1">// 프록시를 인터페이스로 캐스팅 성송</span>
  <span class="nc">MemberService</span> <span class="n">memberServiceProxy</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MemberService</span><span class="o">)</span><span class="n">factory</span><span class="o">.</span><span class="na">getProxy</span><span class="o">();</span>

  <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"proxy class={}"</span><span class="o">,</span> <span class="n">memberServiceProxy</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>

  <span class="c1">// 구현 클래스로 캐스팅 성공</span>
  <span class="nc">MemberServiceImpl</span> <span class="n">memberServiceImplProxy</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MemberServiceImpl</span><span class="o">)</span><span class="n">factory</span><span class="o">.</span><span class="na">getProxy</span><span class="o">();</span>

  <span class="nc">Assertions</span><span class="o">.</span><span class="na">assertInstanceOf</span><span class="o">(</span><span class="nc">MemberService</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">memberServiceProxy</span><span class="o">);</span>
  <span class="nc">Assertions</span><span class="o">.</span><span class="na">assertInstanceOf</span><span class="o">(</span><span class="nc">MemberServiceImpl</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">memberServiceImplProxy</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p><img data-src="/assets/posts/img/spring/spring_basic/spring_17_06.png" alt="Alt text" data-proofer-ignore></p><p><strong>CGLIB 프록시 캐스팅</strong> <img data-src="/assets/posts/img/spring/spring_basic/spring_17_07.png" alt="Alt text" data-proofer-ignore></p><p>이 경우에는 CGLIB Proxy를 대상 클래스인 MemberServiceImpl 타입으로 캐스팅이 가능하다. CGLIB은 구체 클래스인 MemberServiceImpl 기반으로 프록시를 생성하기 떄문에, 구체 클래스인 MemberServiceImpl과 MemberServiceImpl의 인터페이스인 MemberService으로도 타입 캐스팅이 가능하다.</p><p>이러한 캐스팅문제는 의존관계 주입시에 발생하게 된다.</p><h4 id="의존관계-주입"><span class="mr-2">의존관계 주입</span><a href="#의존관계-주입" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>JDK 동적 프록시 사용시 의존관계 주입을 할때 생기는 문제의 예시 코드를 보면 아래와 같다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="nd">@Slf4j</span>
<span class="nd">@Aspect</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProxyDIAspect</span> <span class="o">{</span>

  <span class="nd">@Before</span><span class="o">(</span><span class="s">"execution(* hello.aop..*.*(..))"</span><span class="o">)</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doTrace</span><span class="o">(</span><span class="nc">JoinPoint</span> <span class="n">joinPoint</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"[ProxyDIAspect] {}"</span><span class="o">,</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">getSignature</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="nd">@Slf4j</span>
<span class="nd">@Import</span><span class="o">(</span><span class="nc">ProxyDIAspect</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="c1">// JDK 동적 프록시, DI 예외 발생</span>
<span class="nd">@SpringBootTest</span><span class="o">(</span><span class="n">properties</span> <span class="o">=</span> <span class="o">{</span><span class="s">"spring.aop.proxy-target-class=false"</span><span class="o">})</span>
<span class="c1">// CGLIB 프록시, 성공</span>
<span class="c1">// @SpringBootTest(properties = {"spring.aop.proxy-target-class=true"})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProxyDITest</span> <span class="o">{</span>

  <span class="c1">// JDK 동적 프록시 OK, CGLIB OK</span>
  <span class="nd">@Autowired</span>
  <span class="nc">MemberService</span> <span class="n">memberService</span><span class="o">;</span>

  <span class="c1">// JDK 동적 프록시 X, CGLIB OK</span>
  <span class="nd">@Autowired</span>
  <span class="nc">MemberServiceImpl</span> <span class="n">memberServiceImpl</span><span class="o">;</span>

  <span class="nd">@Test</span>
  <span class="kt">void</span> <span class="nf">go</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"memberService class={}"</span><span class="o">,</span> <span class="n">memberService</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"memberServiceImpl class={}"</span><span class="o">,</span> <span class="n">memberServiceImpl</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
    <span class="n">memberServiceImpl</span><span class="o">.</span><span class="na">hello</span><span class="o">(</span><span class="s">"hello"</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>위 예시 코드의 경우, 실행해보면 의존관계를 주입하는 시점에 타입과 관련된 에러가 발생하게 된다.</p><pre><code class="language-log">BeanNotOfRequiredTypeException: Bean named 'memberServiceImpl' is expected to be of type 'hello.aop.member.MemberServiceImpl' but was actually of type 'com.sun.proxy.$Proxy54'
</code></pre><p>즉, memberSericeImpl에 주입되길 기대하는 타입은 ‘hello.aop.member.MemberServiceImpl’ 이지만, 실제 주입시 넘어온 타입은 ‘com.sun.proxy.$Proxy54’ 이여서 예외가 발생한 것이다. 이에 대하여 동작에 대한 설명은 아래와 같다.</p><p><img data-src="/assets/posts/img/spring/spring_basic/spring_17_08.png" alt="Alt text" data-proofer-ignore></p><ul><li>@Autowired MemberService memberService<ul><li>JDK Proxy는 MemberService 인터페이스를 기반으로 만들어지기 때문에 해당 타입으로 캐스팅할 수 있으며 주입도 가능</ul><li>@Autowired MemberService memberServiceImpl<ul><li>해당 부분에서 예외 발생<li>JDK Proxy는 MemberService 인터페이스를 기반으로 만들어지기 때문에 memberServiceImpl 타입에 대해 알지 못하므로 캐스팅할 수 없고, 주입 또한 불가능</ul></ul><p>위 상황에 대하여 CGLIB 프록시를 구체 클래스에 주입시에는 정상적으로 의존관계 주입이 동작하게 된다.</p><p><img data-src="/assets/posts/img/spring/spring_basic/spring_17_09.png" alt="Alt text" data-proofer-ignore></p><ul><li>@Autowired MemberService memberService<ul><li>CGLIB Proxy는 MemberServiceImpl 구체 클래스 기반으로 만들어지고, MemberServiceImpl 은 MemberService 인터페이스를 구현했기 때문에 타입 캐스팅 및 주입 가능</ul><li>@Autowired MemberService memberServiceImpl<ul><li>CGLIB Proxy는 MemberServiceImpl 구체 클래스를 기반으로 만들어지기 때문에 해당 타입으로 캐스팅할 수 있으며 주입도 가능</ul></ul><p><br /></p><p>위 내용에 대하여 정리하자면, JDK 동적 프록시는 인터페이스가 아닌 구현 객체 타입에 의존관계를 주입할 수 없다. 반대로 CGLIB 프록시는 대상 객체(구현 객체) 타입에 의존관계를 주입할 수 있다.</p><p><br /></p><p>객체지향 관점으로 바라보게 되면, 실제로 개발할 떄는 인터페이스가 았다면 인터페이스를 기반으로 의존관계 주입을 받는 것이 맞다. 인터페이스를 기반으로 의존관계를 주입받아야 DI 받는 클라이언트 코드의 변경 없이 구현 클래스를 변경할 수 있기 때문이다. 구현 클래스에 의존관계를 주입받게 되면 향후 구현 클래스를 변경할떄 의존관계 주입을 받는 클라이언트 코드도 함꼐 변경해야 한다.</p><p>그러므로 올바르게 잘 설계된 어플리케시연 이라면 위와 같은 문제가 자주 발생하지 않는다. 그러나 가끔 테스트 또는 여러 이유로 AOP 프록시가 적용된 구체 클래스를 직접 의존관계 주입 받아야 하는 경우가 생기게 되는데, 이떄는 CGLIB을 통하여 구체 클래스 기반으로 AOP 프록시를 적용하면 된다.</p><h4 id="cglib"><span class="mr-2">CGLIB</span><a href="#cglib" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>스프링에서 CGLIB은 구체 클래스를 상속 받아서 AOP 프록시를 생성할 때 사용한다. CGLIB은 구체 클래스를 상속 받기 때문에 아래와 같은 문게가 발생한다.</p><ul><li>대상 클래스에 기본 생성자 필수<li>생성자 2번 호출 문제<li>final 키워드 클래스, 메소드 사용 불가</ul><h5 id="대상-클래스에-기본-생성자-필수"><span class="mr-2">대상 클래스에 기본 생성자 필수</span><a href="#대상-클래스에-기본-생성자-필수" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5></h5><p>CGLIB은 구체 클래스를 상속 받는다. 자바에서 상속을 받으면 자식 클래스의 생성자를 호출할떄 자식 클래스의 생성자에서 부모 클래스의 생성자도 호출해야 한다. (이 부분이 생략되어 있따면 자식 클래스의 생성자 첫줄에 부모 클래스의 기본 생성자를 호출하는 super()가 자동으로 들어간다.)</p><p>CGLIB을 사용할 떄 CGLIB가 만드는 프록시의 생성자는 개발자가 호출하는 것이 아니다. CGLIB 프록시는 대상 클래스를 상속받고, 생성자에서 대상 클래스의 기본 생성자를 호출한다. 그러므로 대상 클래스의 기본 생성자를 만들어야 CGLIB 프록시가 기본 생성자를 호출할 수 있다.</p><h5 id="생성자-2번-호출-문제"><span class="mr-2">생성자 2번 호출 문제</span><a href="#생성자-2번-호출-문제" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5></h5><p>CGLIB은 구체 클래스를 상속 받는다. 자바에서 상속을 받으면 자식 클래스의 생성자를 호출할떄 자식 클래스의 생성자에서 부모 클래스의 생성자도 호출해야 한다. 이떄 아래와 같이 두번의 생성자가 호출되어 진다.</p><ul><li>실제 target 객체를 생성할 떄<li>프록시 객체를 생성할 떄 부모 클래스의 생성자 호출</ul><p><img data-src="/assets/posts/img/spring/spring_basic/spring_17_10.png" alt="Alt text" data-proofer-ignore></p><h5 id="final-키워드-클래스-메소드-사용-불가"><span class="mr-2">final 키워드 클래스, 메소드 사용 불가</span><a href="#final-키워드-클래스-메소드-사용-불가" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5></h5><p>final 키워드가 클래스에 있다면 상속이 불가능하고, 메소드에 있다면 오버라이딩이 불가능하다. 그러므로 상속을 기반으로 하는 CGLIB 프록시 방식은 두경우에는 프록시가 생성되지 않거나 정상동작 하지 않는다.</p><p>그러나 실무에선 프레임워크와 같은 개발이 아닌 일반 어플리케이션을 개발할 떄는 보통 final 키워드를 잘 사용하지 않기 떄문에, 이부분에 대해선 크게 문제되지 않는다.</p><h4 id="스프링의-해결책"><span class="mr-2">스프링의 해결책</span><a href="#스프링의-해결책" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>스프링 4.0 부터 objenesis 라는 라이브러리를 사용하여 기본생성자 없이 객체 생성이 가능해졌다. 기본 생성자없이 객체 생성이 가능해 졌으므로 CGLIB의 기본생성자가 필수인 문제와 생성자 2번 호출 문제가 해결되었다.</p><p>스프링 부트 2.0 부터는 CGLIB을 기본으로 사용하도록 되어서 구체 클래스 타입으로 의존관계를 주입하는 문제를 해결하였다. 스프링 부트 2.0 버전부터는 별도의 설정이 없다면 AOP를 적용할떄 proxyTargetClass=true 으로 설정하여 사용한다. 따라서 인터페이스가 있어도 JDK 동적 프록시를 사용하는 것이 아니라 항상 CGLIB을 사용하여 구체클래스를 기반으로 프록시를 생성한다.</p><hr /><p>참고</p><ul><li>스프링 핵심 원리 - 고급편(김영한)</ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/backend/'>Backend</a>, <a href='/categories/spring-framework/'>Spring Framework</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/web/" class="post-tag no-text-decoration" >Web</a> <a href="/tags/spring-framework/" class="post-tag no-text-decoration" >Spring Framework</a> <a href="/tags/aop/" class="post-tag no-text-decoration" >AOP</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Spring Framework - AOP 주의사항 - My Technical Diary&amp;url=https://issuh.github.io/posts/spring-17/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Spring Framework - AOP 주의사항 - My Technical Diary&amp;u=https://issuh.github.io/posts/spring-17/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://issuh.github.io/posts/spring-17/&amp;text=Spring Framework - AOP 주의사항 - My Technical Diary" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/educative-distributed-system-10/">Distributed Systems - Coordination Patterns</a><li><a href="/posts/educative-distributed-system-04/">Distributed Systems - CAP</a><li><a href="/posts/educative-distributed-system-03/">Distributed Systems - Replication</a><li><a href="/posts/my_project_simpledb/">simpleDB - 메모리</a><li><a href="/posts/ps-hackerrank-01/">HackerRandk - Fraudulent Activity Notifications</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ps/">PS</a> <a class="post-tag" href="/tags/leetcode/">Leetcode</a> <a class="post-tag" href="/tags/programmers/">Programmers</a> <a class="post-tag" href="/tags/spring-framework/">Spring Framework</a> <a class="post-tag" href="/tags/web/">Web</a> <a class="post-tag" href="/tags/c/">C++</a> <a class="post-tag" href="/tags/hash/">Hash</a> <a class="post-tag" href="/tags/database/">DataBase</a> <a class="post-tag" href="/tags/tree/">Tree</a> <a class="post-tag" href="/tags/array/">Array</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/spring-10/"><div class="card-body"> <em class="timeago small" data-ts="1698987600" > 2023-11-03 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Spring Framework - 스프링이 지원하는 프록시</h3><div class="text-muted small"><p> 프록시 팩토리 스프링은 동적 프록시를 통합해서 편리하게 만들어주는 프록시 팩토리(ProxyFactory)라는 기능을 제공한다. 과거에는 상황에 따라서 JDK 동적 프록시를 사용하거나 CGIL을 사용해야 했다면, 이제는 프록시 팩토리 하나로 편리하게 동적 프록시를 생성 할 수 있다. 인터페이스, 구체 클래스별 사용 기술 프록시 팩토리는 인터페이스가...</p></div></div></a></div><div class="card"> <a href="/posts/spring-11/"><div class="card-body"> <em class="timeago small" data-ts="1698994800" > 2023-11-03 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Spring Framework - 빈 후처리기</h3><div class="text-muted small"><p> 빈 후처리기 일반적인 빈 등록 @Bean이나 컴포넌트 스캔으로 스프링 빈을 등록하면, 스프링은 대상 객체를 생성하고 스프링 컨테이터 내부의 빈 저장소에 등록한다. 그리고 이후에는 스프링 컨테이너를 통해 등록한 스프링 빈을 조죄해서 사용하면 된다. 빈 후처리기(BeanPostProcessor) 스프링이 빈 저장소에 등록할 목적으로 생성한 객체...</p></div></div></a></div><div class="card"> <a href="/posts/spring-12/"><div class="card-body"> <em class="timeago small" data-ts="1699236000" > 2023-11-06 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Spring Framework - 자동 프록시 생성기와 @Aspect</h3><div class="text-muted small"><p> 자동 프록시 생성기와 @Aspect 자동 프록시 생성기(AnnotationAwareAspectJAutoProxyCreator)는 Advisor를 자동으로 찾아와서 필요한 곳에 프록시를 생성하고 적용한다. 그리고 추가로 하나의 역할을 더 하는데, @Aspect를 찾아서 이것을 Advisor로 만드는 일이다. 즉, 자동 프록시 생성기는 크게 두가지 일...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/spring-16/" class="btn btn-outline-primary" prompt="Older"><p>Spring Framework - AOP 구현 예시</p></a> <a href="/posts/my_project_simpledb/" class="btn btn-outline-primary" prompt="Newer"><p>simpleDB - 메모리</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/ISSuh">ISSuh</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ps/">PS</a> <a class="post-tag" href="/tags/leetcode/">Leetcode</a> <a class="post-tag" href="/tags/programmers/">Programmers</a> <a class="post-tag" href="/tags/spring-framework/">Spring Framework</a> <a class="post-tag" href="/tags/web/">Web</a> <a class="post-tag" href="/tags/c/">C++</a> <a class="post-tag" href="/tags/hash/">Hash</a> <a class="post-tag" href="/tags/database/">DataBase</a> <a class="post-tag" href="/tags/tree/">Tree</a> <a class="post-tag" href="/tags/array/">Array</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-157715138-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-157715138-1'); }); </script>

<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Spring Data JPA - 쿼리 메소드 기능" /><meta property="og:locale" content="en" /><meta name="description" content="메소드 이름으로 쿼리 생성" /><meta property="og:description" content="메소드 이름으로 쿼리 생성" /><link rel="canonical" href="https://issuh.github.io/posts/spring-data-jpa-02/" /><meta property="og:url" content="https://issuh.github.io/posts/spring-data-jpa-02/" /><meta property="og:site_name" content="My Technical Diary" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-10-30T17:50:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Spring Data JPA - 쿼리 메소드 기능" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-04-23T22:54:02+09:00","datePublished":"2023-10-30T17:50:00+09:00","description":"메소드 이름으로 쿼리 생성","headline":"Spring Data JPA - 쿼리 메소드 기능","mainEntityOfPage":{"@type":"WebPage","@id":"https://issuh.github.io/posts/spring-data-jpa-02/"},"url":"https://issuh.github.io/posts/spring-data-jpa-02/"}</script><title>Spring Data JPA - 쿼리 메소드 기능 | My Technical Diary</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="My Technical Diary"><meta name="application-name" content="My Technical Diary"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/profile.jpeg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">My Technical Diary</a></div><div class="site-subtitle font-italic">ISSuh's tech blog</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/aboutme/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT ME</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/ISSuh" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['yoyus5','naver.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Spring Data JPA - 쿼리 메소드 기능</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Spring Data JPA - 쿼리 메소드 기능</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/ISSuh">ISSuh</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1698655800" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2023-10-30 </em> </span> <span> Updated <em class="timeago" data-ts="1713880442" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2024-04-23 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2695 words"> <em>14 min</em> read</span></div></div></div><div class="post-content"><h3 id="메소드-이름으로-쿼리-생성"><span class="mr-2">메소드 이름으로 쿼리 생성</span><a href="#메소드-이름으로-쿼리-생성" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>메소드 이름을 분석해서 JPQL 쿼리 실행</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MemberRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="c1">// 이름이 username과 같고 나이가 age 보다 많은 Member의 리스트 반환</span>
  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findByUsernameAndAgeGreaterThan</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">,</span> <span class="kt">int</span> <span class="n">age</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li>쿼리 메소드 필터 조건<ul><li><a href="https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#jpa.query-methods.query-creation">스프링 데이터 JPA 공식 문서 참고</a></ul></ul><h4 id="스프링-데이터-jpa가-제공하는-쿼리-메소드-기능"><span class="mr-2">스프링 데이터 JPA가 제공하는 쿼리 메소드 기능</span><a href="#스프링-데이터-jpa가-제공하는-쿼리-메소드-기능" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><ul><li>조회: find…By ,read…By ,query…By get…By,<ul><li><a href="https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.query-methods.query-creation">Query Creation 문서 참고</a><li>findHelloBy 처럼 …에 식별하기 위한 내용(설명)이 들어가도 됨</ul><li>COUNT: count…By<ul><li>반환타입 long</ul><li>EXISTS: exists…By<ul><li>반환타입 boolean</ul><li>삭제: delete…By, remove…By<ul><li>반환타입 long</ul><li>DISTINCT: findDistinct, findMemberDistinctBy<li>LIMIT: findFirst3, findFirst, findTop, findTop3<ul><li><a href="https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.limit-query-result">Limiting Query Results 문서 참고</a></ul></ul><p><br /></p><p>이 기능은 엔티티의 필드명이 변경되면 인터페이스에 정의한 메소드 이름도 꼭 함꼐 변경해야 함. 그렇지 않으면 어플리케이션 실행 시점에 오류 발생.</p><h3 id="jpa-namedquery"><span class="mr-2">JPA NamedQuery</span><a href="#jpa-namedquery" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>JPA의 NamedQuery를 호출할 수 있음</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="c1">// Entity에 NameQuery 정의</span>
<span class="nd">@Entity</span>
<span class="nd">@NamedQuery</span><span class="o">(</span>
  <span class="n">name</span><span class="o">=</span><span class="s">"Member.findByUsername"</span><span class="o">,</span>
  <span class="n">query</span><span class="o">=</span><span class="s">"select m from Member m where m.username = :username"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Member</span> <span class="o">{</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="c1">// JPA를 직접 사용하여 NamedQuery 호출</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberRepository</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="n">resultList</span> <span class="o">=</span>
            <span class="n">em</span><span class="o">.</span><span class="na">createNamedQuery</span><span class="o">(</span><span class="s">"Member.findByUsername"</span><span class="o">,</span> <span class="nc">Member</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"username"</span><span class="o">,</span> <span class="n">username</span><span class="o">)</span>
                <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MemberRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="c1">// 스프링 데이터 JPA로 NamedQuery 호출</span>
  <span class="nd">@Query</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"Member.findByUsername"</span><span class="o">)</span>
  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findByUsername</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"username"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">username</span><span class="o">);</span>

  <span class="o">...</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li>스프링 데이터 JPA는 선언한 “도메인 클래스 + . + 메소드 이름” 으로 NamedQuery를 찾아서 실행<li>만약 실행할 NamedQuery가 없다면 메소드 이름으로 쿼리 생성 전략을 사용<li>어플리케이션 로딩시점에 정의한 NamedQuery를 파싱하여 검사함<ul><li>문법오류가 있다면 로딩 시점에 예외 발생</ul><li>스프링 데이터 JPA를 사용하면 실무에서 NamedQuery를 직접 등록하여 사용할 일은 거의 없음<ul><li>NamedQuery대신 @Query를 사용하여 리포지토리 메소드에 쿼리를 직접 정의</ul></ul><h3 id="query-리포지토리-메소드에-쿼리-정의"><span class="mr-2">@Query. 리포지토리 메소드에 쿼리 정의</span><a href="#query-리포지토리-메소드에-쿼리-정의" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MemberRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="nd">@Query</span><span class="o">(</span><span class="s">"select m from Member m where m.username= :username and m.age = :age"</span><span class="o">)</span>
  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findUser</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"username"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">username</span><span class="o">,</span> <span class="nd">@Param</span><span class="o">(</span><span class="s">"age"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">age</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li>@org.springframework.data.jpa.repository.Query 어노테이션 사용<li>실행할 메소드에 정적 쿼리를 직접 작성하므로 이름없는 NamedQuery라고 할 수 있음<li>JPA NamedQuery처럼 어플리케이션 실행 시점에 문법 오류를 발견 할 수 있음</ul><blockquote><p>보통 실무에서는 메소드 이름으로 쿼리 생성 기능은 파라미터가 증가하면 메소드 이름이 매우 길어지므로 @Query 기능을 자주 사용함</p></blockquote><h4 id="query로-값-dto-조회"><span class="mr-2">@Query로 값, DTO 조회</span><a href="#query로-값-dto-조회" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberDto</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">username</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">teamName</span><span class="o">;</span>

 <span class="kd">public</span> <span class="nf">MemberDto</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">,</span> <span class="nc">String</span> <span class="n">username</span><span class="o">,</span> <span class="nc">String</span> <span class="n">teamName</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">username</span> <span class="o">=</span> <span class="n">username</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">teamName</span> <span class="o">=</span> <span class="n">teamName</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MemberRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="c1">// DTO로 직접 조회</span>
 <span class="nd">@Query</span><span class="o">(</span><span class="s">"select new study.datajpa.dto.MemberDto(m.id, m.username, t.name) "</span> <span class="o">+</span>
        <span class="s">"from Member m join m.team t"</span><span class="o">)</span>
  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">MemberDto</span><span class="o">&gt;</span> <span class="nf">findMemberDto</span><span class="o">();</span>

  <span class="c1">// 단순히 값 하나를 조회</span>
  <span class="nd">@Query</span><span class="o">(</span><span class="s">"select m.username from Member m"</span><span class="o">)</span>
  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">findUsernameList</span><span class="o">();</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li>DTO로 직접 조회하려면 JPA의 new 명령어를 사용해야함<li>DTO에는 생성자를 정의해주고 그 생성자에 맞춰 필드를 넣어주어야 함</ul><h4 id="파라미터-바인딩"><span class="mr-2">파라미터 바인딩</span><a href="#파라미터-바인딩" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><div class="language-sql highlighter-rouge"><div class="code-header"> <span data-label-text="Sql"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c1">-- 위치 기반</span>
<span class="k">select</span> <span class="n">m</span> <span class="k">from</span> <span class="n">Member</span> <span class="n">m</span> <span class="k">where</span> <span class="n">m</span><span class="p">.</span><span class="n">username</span> <span class="o">=</span> <span class="o">?</span><span class="mi">0</span>

<span class="c1">-- 이름 기반</span>
<span class="k">select</span> <span class="n">m</span> <span class="k">from</span> <span class="n">Member</span> <span class="n">m</span> <span class="k">where</span> <span class="n">m</span><span class="p">.</span><span class="n">username</span> <span class="o">=</span> <span class="p">:</span><span class="n">name</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MemberRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="nd">@Query</span><span class="o">(</span><span class="s">"select m from Member m where m.username = :name"</span><span class="o">)</span>
  <span class="nc">Member</span> <span class="nf">findMembers</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"name"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">username</span><span class="o">);</span>

  <span class="nd">@Query</span><span class="o">(</span><span class="s">"select m from Member m where m.username in :names"</span><span class="o">)</span>
  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findByNames</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"names"</span><span class="o">)</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">names</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li>보통 코드의 가독성과 유지보수를 위해 이름기반 파라미터 바인딩을 사용<li>Collection 타입으로 IN 정도 지원 함</ul><h3 id="반환-타입"><span class="mr-2">반환 타입</span><a href="#반환-타입" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MemberRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="c1">// 컬렉션 반환</span>
  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">);</span>

  <span class="c1">// 단건 반환</span>
  <span class="nc">Member</span> <span class="nf">findByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">);</span>

  <span class="c1">// 단건 Optional 반환</span>
  <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li><a href="https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repository-query-return-types">스프링 데이터 JPA 공식 문서 참고</a><li>조회 결과가 많거나 없으면 아래와 같이 처리<ul><li>컬렉션<ul><li>결과 없음 : 빈 컬렉션 반환</ul><li>단건 조회<ul><li>결과 없음 : null 반환<li>결과가 2건 이상 : javax.persistence.NonUniqueResultException 예외 발생</ul></ul></ul><h3 id="페이징과-정렬"><span class="mr-2">페이징과 정렬</span><a href="#페이징과-정렬" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ul><li>페이징 및 정렬 기능<ul><li>org.springframework.data.domain.Sort<ul><li>정렬 기능</ul><li>org.springframework.data.domain.Pageable<ul><li>페이징 기능<li>내부에 Sort 포함</ul></ul><li>반환 타입<ul><li>org.springframework.data.domain.Page<ul><li>추가 count 쿼리 결과를 포함하는 페이징</ul><li>org.springframework.data.domain.Slice<ul><li>추가 count 쿼리 없이 다음 페이지만 학인 가능<li>내부적으로 limit + 1 조회</ul><li>List<ul><li>추가 count 쿼리 없이 결과만 반환</ul></ul></ul><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MemberRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="c1">// count 쿼리 사용</span>
  <span class="nc">Page</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findByAge</span><span class="o">(</span><span class="kt">int</span> <span class="n">age</span><span class="o">,</span> <span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">);</span>

  <span class="c1">// count 쿼리 사용 안함</span>
  <span class="nc">Slice</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findByAge</span><span class="o">(</span><span class="kt">int</span> <span class="n">age</span><span class="o">,</span> <span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">);</span>

  <span class="c1">// count 쿼리 사용 안함</span>
  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findByAge</span><span class="o">(</span><span class="kt">int</span> <span class="n">age</span><span class="o">,</span> <span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">);</span>

  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findByAge</span><span class="o">(</span><span class="kt">int</span> <span class="n">age</span><span class="o">,</span> <span class="nc">Sort</span> <span class="n">sort</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">paging</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
  <span class="c1">//given</span>
  <span class="n">memberRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="nc">Member</span><span class="o">(</span><span class="s">"member1"</span><span class="o">,</span> <span class="mi">10</span><span class="o">));</span>
  <span class="n">memberRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="nc">Member</span><span class="o">(</span><span class="s">"member2"</span><span class="o">,</span> <span class="mi">10</span><span class="o">));</span>
  <span class="n">memberRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="nc">Member</span><span class="o">(</span><span class="s">"member3"</span><span class="o">,</span> <span class="mi">10</span><span class="o">));</span>
  <span class="n">memberRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="nc">Member</span><span class="o">(</span><span class="s">"member4"</span><span class="o">,</span> <span class="mi">10</span><span class="o">));</span>
  <span class="n">memberRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="nc">Member</span><span class="o">(</span><span class="s">"member5"</span><span class="o">,</span> <span class="mi">10</span><span class="o">));</span>
  <span class="kt">int</span> <span class="n">age</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>
  <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
  <span class="kt">int</span> <span class="n">limit</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>

  <span class="c1">//when</span>
  <span class="nc">PageRequest</span> <span class="n">pageRequest</span> <span class="o">=</span> <span class="nc">PageRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">offset</span><span class="o">,</span> <span class="n">limit</span><span class="o">,</span> <span class="nc">Sort</span><span class="o">.</span><span class="na">by</span><span class="o">(</span><span class="nc">Sort</span><span class="o">.</span><span class="na">Direction</span><span class="o">.</span><span class="na">DESC</span><span class="o">,</span> <span class="s">"username"</span><span class="o">));</span>
  <span class="nc">Page</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="n">page</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findByAge</span><span class="o">(</span><span class="n">age</span><span class="o">,</span> <span class="n">pageRequest</span><span class="o">);</span>

  <span class="c1">//then</span>
  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="n">content</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="na">getContent</span><span class="o">();</span>
  <span class="nc">Assertions</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span><span class="n">content</span><span class="o">.</span><span class="na">size</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span> <span class="c1">//조회된 데이터 수</span>
  <span class="nc">Assertions</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span><span class="n">page</span><span class="o">.</span><span class="na">getTotalElements</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span> <span class="c1">//전체 데이터 수</span>
  <span class="nc">Assertions</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span><span class="n">page</span><span class="o">.</span><span class="na">getNumber</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span> <span class="c1">//페이지 번호</span>
  <span class="nc">Assertions</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span><span class="n">page</span><span class="o">.</span><span class="na">getTotalPages</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span> <span class="c1">//전체 페이지 번호</span>
  <span class="nc">Assertions</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span><span class="n">page</span><span class="o">.</span><span class="na">isFirst</span><span class="o">()).</span><span class="na">isTrue</span><span class="o">();</span> <span class="c1">//첫번째 항목인가?</span>
  <span class="nc">Assertions</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span><span class="n">page</span><span class="o">.</span><span class="na">hasNext</span><span class="o">()).</span><span class="na">isTrue</span><span class="o">();</span> <span class="c1">//다음 페이지가 있는가?</span>
<span class="o">}</span>
</pre></table></code></div></div><details> <summary>생성되는 SQL 로그</summary><div><pre><code class="language-log">2023-10-31 10:44:00.902 DEBUG 36924 --- [           main] org.hibernate.SQL                        :
    select
        member0_.member_id as member_i1_0_,
        member0_.age as age2_0_,
        member0_.team_id as team_id4_0_,
        member0_.username as username3_0_
    from
        member member0_
    where
        member0_.age=?
    order by
        member0_.username desc limit ?
...

2023-10-31 10:44:00.911 DEBUG 36924 --- [           main] org.hibernate.SQL                        :
    select
        count(member0_.member_id) as col_0_0_
    from
        member member0_
    where
        member0_.age=?
</code></pre></div></details><ul><li>두번쨰 파라미터로 받은 Pageable은 인터페이스 이므로 실제 사용할 떄는 해당 인터페이스를 구현한 org.springframework.data.domain.PageRequest 객체를 사용<li>PageRequest 생성자의 첫번쨰 파라미터는 현재 페이지를, 두번쨰 파라미터는 조회할 데이터의 수를 입력. 그리고 추가로 정렬 정보도 파라미터로 사용 가능<li>페이지는 0부터터 시작 함</ul><h4 id="페이지를-유지하면서-엔티티를-dto로-변환"><span class="mr-2">페이지를 유지하면서 엔티티를 DTO로 변환</span><a href="#페이지를-유지하면서-엔티티를-dto로-변환" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>엔티티를 바로 클라이언트에게 전달하는것은 피하는 것이 좋으므로, 엔티티를 별도의 DTO로 재구성할 필요가 있음</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">paging</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

  <span class="o">...</span>

  <span class="c1">//when</span>
  <span class="nc">PageRequest</span> <span class="n">pageRequest</span> <span class="o">=</span> <span class="nc">PageRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">offset</span><span class="o">,</span> <span class="n">limit</span><span class="o">,</span> <span class="nc">Sort</span><span class="o">.</span><span class="na">by</span><span class="o">(</span><span class="nc">Sort</span><span class="o">.</span><span class="na">Direction</span><span class="o">.</span><span class="na">DESC</span><span class="o">,</span> <span class="s">"username"</span><span class="o">));</span>
  <span class="nc">Page</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="n">page</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findByAge</span><span class="o">(</span><span class="n">age</span><span class="o">,</span> <span class="n">pageRequest</span><span class="o">);</span>

  <span class="nc">Page</span><span class="o">&lt;</span><span class="nc">MemberDto</span><span class="o">&gt;</span> <span class="n">dtoPage</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">m</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">MemberDto</span><span class="o">(</span><span class="n">m</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">m</span><span class="o">.</span><span class="na">getUsername</span><span class="o">()));</span>

  <span class="o">...</span>
<span class="o">}</span>
</pre></table></code></div></div><h4 id="count-쿼리-분리"><span class="mr-2">count 쿼리 분리</span><a href="#count-쿼리-분리" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>다음과 같이 count 쿼리를 별도로 지정하여 살행할 수 있음</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MemberRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="nd">@Query</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"select m from Member m"</span><span class="o">,</span>
        <span class="n">countQuery</span> <span class="o">=</span> <span class="s">"select count(m.username) from Member m"</span><span class="o">)</span>
  <span class="nc">Page</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findMemberAllCountBy</span><span class="o">(</span><span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><details> <summary>생성되는 SQL 로그</summary><div><pre><code class="language-log">2023-10-31 10:57:56.716 DEBUG 37534 --- [           main] org.hibernate.SQL                        :
    select
        member0_.member_id as member_i1_0_,
        member0_.age as age2_0_,
        member0_.team_id as team_id4_0_,
        member0_.username as username3_0_
    from
        member member0_
    order by
        member0_.username desc limit ?
...

2023-10-31 10:57:56.722 DEBUG 37534 --- [           main] org.hibernate.SQL                        :
    select
        count(member0_.username) as col_0_0_
    from
        member member0_
...
</code></pre></div></details><ul><li>데이터베이스의 전체 row의 수를 반한하는 count 쿼리는 매우 무겁기 떄문에 최적화 필요.<li>복잡한 SQL에서는 데이터를 Left Join으로 조회할때, 자동으로 생성되는 count 쿼리도 동일하게 Left Join을 사용하여 전체 수를 조회함. 그러나 단순 count 쿼리에서 까지 Left Join할 필요가 없으므로 최적화를 위해 별도의 count 쿼리를 지정 필요.</ul><blockquote><p>스프링부트3 - 하이버네이트6에서는 의미없는 Left Join을 최적화 하여 위 예시의 경우 Left Join을 추가하지 않음</p></blockquote><h3 id="벌크성-수정-쿼리"><span class="mr-2">벌크성 수정 쿼리</span><a href="#벌크성-수정-쿼리" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MemberRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="nd">@Modifying</span><span class="o">(</span><span class="n">clearAutomatically</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
  <span class="nd">@Query</span><span class="o">(</span><span class="s">"update Member m set m.age = m.age + 1 where m.age &gt;= :age"</span><span class="o">)</span>
  <span class="kt">int</span> <span class="nf">bulkAgePlus</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"age"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">age</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li>벌크성 수정, 삭제 쿼리는 @Modifying 어노테이션 사용<ul><li>사용하지 않으면 다음과 같은 예외 발생<li>org.hibernate.hql.internal.QueryExecutionRequestException: Not supported for DML operations</ul><li>벌크성 쿼리를 실행하고 나서 영속성 컨텍스트 초기화<ul><li>@Modifying(clearAutomatically = true)<li>이 옵션 없다면 영속성 컨텍스트에 과거 값이 남아서 재조회시 문제가 될수 있음</ul><li>벌크 연산은 영속성 컨텍스트를 무시하고 실행되기 떄문에 영속성 컨텍스트에 있는 엔티티 상태와 데이터베이스에 엔티티 상태가 달라질 수 있음<ul><li>권장하는 방안으로는 아래와 같이 두가지가 있음<ul><li>영속성 컨텍스트에 엔티티가 없는 상태에서 벌크 연산을 먼저 실행<li>부득이하게 영속성 컨텍스트에 엔티티가 있다면 벌크 연산 직후 영속성 컨텍스트를 초기화<ul><li>entityManager.clear()</ul></ul></ul></ul><h3 id="entitygraph"><span class="mr-2">@EntityGraph</span><a href="#entitygraph" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>관련된 엔티티들을 SQL 한번에 조회하는 방법</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MemberRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="c1">// 공통 메소드 오버라이드</span>
  <span class="nd">@Override</span>
  <span class="nd">@EntityGraph</span><span class="o">(</span><span class="n">attributePaths</span> <span class="o">=</span> <span class="o">{</span><span class="s">"team"</span><span class="o">})</span>
  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">();</span>

  <span class="c1">// 메소드 이름으로 쿼리 + 엔티티 그래프</span>
  <span class="nd">@EntityGraph</span><span class="o">(</span><span class="n">attributePaths</span> <span class="o">=</span> <span class="o">{</span><span class="s">"team"</span><span class="o">})</span>
  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">);</span>

  <span class="c1">// JPQL + 엔티티 그래프</span>
  <span class="nd">@EntityGraph</span><span class="o">(</span><span class="n">attributePaths</span> <span class="o">=</span> <span class="o">{</span><span class="s">"team"</span><span class="o">})</span>
  <span class="nd">@Query</span><span class="o">(</span><span class="s">"select m from Member m"</span><span class="o">)</span>
  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findMemberEntityGraph</span><span class="o">();</span>
</pre></table></code></div></div><ul><li>사실상 패치조인의 간편버전<li>내부적으로 LEFT OUTER JOIN 사용</ul><h3 id="jpa-hint"><span class="mr-2">JPA Hint</span><a href="#jpa-hint" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>JPA 쿼리 힌트(SQL 힌트가 아니라 JPA 구현체에게 제공하는 힌트)</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MemberRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="c1">// read only 로 힌트 적용</span>
  <span class="nd">@QueryHints</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="nd">@QueryHint</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"org.hibernate.readOnly"</span><span class="o">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s">"true"</span><span class="o">))</span>
  <span class="nc">Member</span> <span class="nf">findReadOnlyByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">);</span>

  <span class="c1">// read only 로 힌트 적용</span>
  <span class="nd">@QueryHints</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="o">{</span> <span class="nd">@QueryHint</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"org.hibernate.readOnly"</span><span class="o">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s">"true"</span><span class="o">)},</span>
              <span class="n">forCounting</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
  <span class="nc">Page</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">,</span> <span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">queryHint</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
  <span class="c1">//given</span>
  <span class="n">memberRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="nc">Member</span><span class="o">(</span><span class="s">"member1"</span><span class="o">,</span> <span class="mi">10</span><span class="o">));</span>
  <span class="n">em</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
  <span class="n">em</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>

  <span class="c1">//when</span>
  <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findReadOnlyByUsername</span><span class="o">(</span><span class="s">"member1"</span><span class="o">);</span>
  <span class="n">member</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="s">"member2"</span><span class="o">);</span>

  <span class="c1">// 쿼리 힌트로 인하여 read only로 설정되었으므로</span>
  <span class="c1">// Update Query를 실행하지 않음</span>
  <span class="n">em</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li>org.springframework.data.jpa.repository.QueryHints 어노테이션 사용<li>forCounting<ul><li>반환 타입으로 Page 인터페이스를 적용하면 추가로 호출하는 페이징을 위한 count 쿼리도 쿼리 힌트 적용<li>기본값 true</ul></ul><h3 id="lock"><span class="mr-2">Lock</span><a href="#lock" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>연관된 엔티티에 대하여 Lock을 걸어 다른 세션에서 접근하지 못하도록 함</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MemberRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="nd">@Lock</span><span class="o">(</span><span class="nc">LockModeType</span><span class="o">.</span><span class="na">PESSIMISTIC_WRITE</span><span class="o">)</span>
  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findLockByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><details> <summary>생성되는 SQL 로그</summary><div><pre><code class="language-log">2023-10-31 12:29:08.176 DEBUG 40588 --- [           main] org.hibernate.SQL                        :
    select
        member0_.member_id as member_i1_0_,
        member0_.age as age2_0_,
        member0_.team_id as team_id4_0_,
        member0_.username as username3_0_
    from
        member member0_
    where
        member0_.username=? for update
</code></pre></div></details><ul><li>org.springframework.data.jpa.repository.Lock 어노테이션을 사용<li>내부적으로 SQL의 for update와 같은 구문 사용<li>어플리케이션이 실시간이 중요하다면 사용에 주의 필요</ul><hr /><p>참고</p><ul><li>실전! 스프링 데이터 JPA(김영한)</ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/backend/'>Backend</a>, <a href='/categories/jpa/'>JPA</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/web/" class="post-tag no-text-decoration" >Web</a> <a href="/tags/spring-framework/" class="post-tag no-text-decoration" >Spring Framework</a> <a href="/tags/database/" class="post-tag no-text-decoration" >DataBase</a> <a href="/tags/jpa/" class="post-tag no-text-decoration" >JPA</a> <a href="/tags/spring-data-jpa/" class="post-tag no-text-decoration" >Spring Data JPA</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Spring Data JPA - 쿼리 메소드 기능 - My Technical Diary&amp;url=https://issuh.github.io/posts/spring-data-jpa-02/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Spring Data JPA - 쿼리 메소드 기능 - My Technical Diary&amp;u=https://issuh.github.io/posts/spring-data-jpa-02/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://issuh.github.io/posts/spring-data-jpa-02/&amp;text=Spring Data JPA - 쿼리 메소드 기능 - My Technical Diary" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/educative-distributed-system-10/">Distributed Systems - Coordination Patterns</a><li><a href="/posts/educative-distributed-system-04/">Distributed Systems - CAP</a><li><a href="/posts/educative-distributed-system-03/">Distributed Systems - Replication</a><li><a href="/posts/my_project_simpledb/">simpleDB - 메모리</a><li><a href="/posts/ps-hackerrank-01/">HackerRandk - Fraudulent Activity Notifications</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ps/">PS</a> <a class="post-tag" href="/tags/leetcode/">Leetcode</a> <a class="post-tag" href="/tags/programmers/">Programmers</a> <a class="post-tag" href="/tags/spring-framework/">Spring Framework</a> <a class="post-tag" href="/tags/web/">Web</a> <a class="post-tag" href="/tags/c/">C++</a> <a class="post-tag" href="/tags/hash/">Hash</a> <a class="post-tag" href="/tags/database/">DataBase</a> <a class="post-tag" href="/tags/tree/">Tree</a> <a class="post-tag" href="/tags/array/">Array</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/spring-data-jpa-01/"><div class="card-body"> <em class="timeago small" data-ts="1698652800" > 2023-10-30 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Spring Data JPA - 공통 인터페이스 기능</h3><div class="text-muted small"><p> 공통 인터페이스 구성 import org.springframework.data.jpa.repository.JpaRepository; public interface ItemRepository extends JpaRepository&amp;lt;Item, Long&amp;gt; { } 스프링 데이터 JPA가 구현 클래스 대신 생성 o...</p></div></div></a></div><div class="card"> <a href="/posts/spring-data-jpa-03/"><div class="card-body"> <em class="timeago small" data-ts="1698729000" > 2023-10-31 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Spring Data JPA - 확장 기능</h3><div class="text-muted small"><p> 사용자 정의 리포지토리 구현 스프링 데이터 JPA 리포지토리는 인터페이스만 정의하고 구현체는 스프링이 자동 생성 스프링 데이터 JPA가 제공하는 인터페이스를 직접 구현하면 구현해야하는 기능이 너무 많음 스프링이 생성해주는 구현이외에 사용자가 직접 구현하고자 할 때는 다음과 같은 방멉이 있음. 1 2 3 4 // 사용자 정의 인터페이스 ...</p></div></div></a></div><div class="card"> <a href="/posts/spring-data-jpa-04/"><div class="card-body"> <em class="timeago small" data-ts="1698736200" > 2023-10-31 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Spring Data JPA - 스프링 데이터 JPA 구현체 분석</h3><div class="text-muted small"><p> 스프링 데이터 JPA 구현체 분석 스프링 데이터 JPA가 제공하는 공통 인터페이스의 구현체 org.springframework.data.jpa.repository.support.SimpleJpaRepository 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 @Repository @Tran...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/spring-data-jpa-01/" class="btn btn-outline-primary" prompt="Older"><p>Spring Data JPA - 공통 인터페이스 기능</p></a> <a href="/posts/spring-data-jpa-03/" class="btn btn-outline-primary" prompt="Newer"><p>Spring Data JPA - 확장 기능</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/ISSuh">ISSuh</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ps/">PS</a> <a class="post-tag" href="/tags/leetcode/">Leetcode</a> <a class="post-tag" href="/tags/programmers/">Programmers</a> <a class="post-tag" href="/tags/spring-framework/">Spring Framework</a> <a class="post-tag" href="/tags/web/">Web</a> <a class="post-tag" href="/tags/c/">C++</a> <a class="post-tag" href="/tags/hash/">Hash</a> <a class="post-tag" href="/tags/database/">DataBase</a> <a class="post-tag" href="/tags/tree/">Tree</a> <a class="post-tag" href="/tags/array/">Array</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-157715138-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-157715138-1'); }); </script>
